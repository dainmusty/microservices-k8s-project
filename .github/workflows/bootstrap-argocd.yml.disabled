name: Bootstrap ArgoCD

on:
  workflow_run:
    workflows: ["Deploy Infrastructure"]
    types:
      - completed

env:
  AWS_REGION: us-east-1
  CLUSTER_NAME: dev_eks_cluster
  AWS_ACCOUNT_ID: 651706774390
  ROLE_NAME: microservices-project-dev-tf-role
  BOOTSTRAP_DIR: k8s/bootstrap
  BOOTSTRAP_FILE_NAME: bootstrap-argo-app.yaml

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap-argocd:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/${{ env.ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          echo "Updating kubeconfig..."
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.CLUSTER_NAME }}

      - name: Validate cluster connectivity
        run: |
          echo "Checking API availability..."
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy ArgoCD bootstrap App of Apps
        run: |
          echo "Applying bootstrap manifest..."
          kubectl apply -f ${{ env.BOOTSTRAP_DIR }}/${{ env.BOOTSTRAP_FILE_NAME }}

      - name: Check ArgoCD Status
        run: |
          echo "Checking ArgoCD pods status..."
          kubectl get pods -n argocd || true
          echo "Waiting for ArgoCD server to be ready..."
          kubectl wait \
            --for=condition=Ready pod \
            -l app.kubernetes.io/name=argocd-server \
            -n argocd --timeout=180s || true

      - name: Install ArgoCD CLI
        run: |
          echo "Installing ArgoCD CLI..."
          curl -sSL -o /usr/local/bin/argocd \
            https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x /usr/local/bin/argocd

      - name: ArgoCD Login (in-cluster mode)
        run: |
          echo "Logging into ArgoCD using cluster mode..."
          argocd login --core

      - name: Sync Bootstrap ArgoCD App
        run: |
          echo "Starting sync of root ArgoCD application..."
          argocd app sync root-app || argocd app sync bootstrap-app || true

      - name: Wait for Application Health
        run: |
          echo "Waiting for bootstrap app to be healthy..."
          argocd app wait root-app --health --timeout 120 || \
          argocd app wait bootstrap-app --health --timeout 120 || true

      - name: Final Status Output
        run: |
          echo "Listing ArgoCD apps..."
          kubectl get applications -n argocd || true
          echo "Listing workload pods..."
          kubectl get pods -A || true
