name: Infrastructure Deploy

on:
  pull_request:
    branches: [ main ]
    paths:
      - "terraform/**"

  push:
    branches: [ main ]
    paths:
      - "terraform/**"

  workflow_dispatch:



jobs:
  
  # ðŸ”¹ Runs on PR â†’ only terraform plan (no apply)
  plan:
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      packages: write
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/terraform.yml
    with:
      working_directory: terraform/root-modules/env/dev
      apply: false
    secrets: inherit

  # ðŸ”¹ Runs on push to main â†’ apply infra changes
  apply:
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      packages: write

    if: github.event_name == 'push'
    uses: ./.github/workflows/terraform.yml
    with:
      working_directory: terraform/root-modules/env/dev
      apply: true          # <-- triggers environment approval
    secrets: inherit
